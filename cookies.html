<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cookies & Einwilligungen – Deine Website</title>
  <!-- Hinweis: Diese Datei ist self‑contained. Sie nutzt möglichst neutrale Klassen,
       damit sie sich am bestehenden Styling deiner index.html orientieren kann.
       Wenn du eine zentrale styles.css hast, binde sie hier ein: -->
  <!-- <link rel="stylesheet" href="/styles.css"> -->

  <style>
    /* Minimaler, neutraler Stil – übernimmt Grund-Styles der Seite.
       Passe Variablen ggf. an dein Design an. */
    :root{
      --bg: #0b0b0b;            /* dunkler Hintergrund-Fallback, falls Seite dark ist */
      --bg-panel: #141414;
      --text: #eaeaea;
      --muted: #9aa0a6;
      --primary: #4f46e5;
      --border: #2a2a2a;
      --success: #16a34a;
      --warning: #ca8a04;
      --radius: 14px;
      --shadow: 0 6px 24px rgba(0,0,0,.25);
    }
    @media(prefers-color-scheme: light){
      :root{ --bg:#ffffff; --bg-panel:#f7f7f8; --text:#0b0b0f; --muted:#60646c; --border:#e6e6ea; }
    }
    body{background:var(--bg); color:var(--text); margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";}
    .container{max-width:920px;margin:0 auto;padding:32px 20px;}
    h1{font-size:clamp(26px,3.2vw,40px);line-height:1.15;margin:8px 0 18px}
    h2{font-size:clamp(20px,2.4vw,28px);margin:28px 0 12px}
    p,li{color:var(--text);opacity:.95}
    .panel{background:var(--bg-panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);}
    .panel.pad{padding:20px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:16px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:transparent;color:var(--text);padding:10px 16px;border-radius:12px;cursor:pointer;transition:.2s;
      font-weight:600}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:var(--primary);border-color:transparent;color:#fff}
    .btn.success{background:var(--success);border-color:transparent;color:#fff}
    .btn.warning{background:var(--warning);border-color:transparent;color:#111}
    .btn.ghost{background:transparent}
    .switch{position:relative;width:48px;height:28px;background:#8884;border-radius:999px;transition:.2s;border:1px solid var(--border)}
    .switch::after{content:"";position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:999px;background:#fff;transition:.2s}
    .switch[data-on="true"]{background:var(--primary)}
    .switch[data-on="true"]::after{transform:translateX(20px)}

    /* Banner */
    .cookie-banner{position:fixed;inset:auto 0 0 0;z-index:9999;padding:16px}
    .cookie-banner .content{display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .cookie-banner .text{flex:1 1 420px}

    /* Modal */
    dialog.cookie-modal{border:1px solid var(--border);background:var(--bg-panel);color:var(--text);border-radius:20px;padding:0;max-width:720px;width:calc(100% - 32px)}
    dialog::backdrop{backdrop-filter:blur(4px);background:rgba(0,0,0,.35)}
    .modal-head{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal-body{padding:14px 20px 20px}
    .cat{display:flex;align-items:center;gap:14px;justify-content:space-between;border:1px solid var(--border);border-radius:14px;padding:14px 16px;margin:10px 0;background:transparent}
    .cat .meta{max-width:560px}
    .badge{font-size:12px;border:1px solid var(--border);padding:3px 8px;border-radius:999px;}
    .sticky-revoke{position:fixed;right:14px;bottom:86px;z-index:9999}

    /* Placeholder Cards */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{border:1px solid var(--border);border-radius:16px;padding:14px;background:transparent}
    .center{display:flex;align-items:center;justify-content:center;min-height:180px}
    .placeholder{display:flex;flex-direction:column;align-items:center;gap:10px}
    .placeholder small{color:var(--muted)}
    .input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text)}
    label a{color:var(--primary);text-decoration:underline}
  </style>
</head>
<body>
  <header class="container">
    <h1>Cookies & Einwilligungen</h1>
    <p class="muted">Diese Seite zeigt dir transparent, welche Dienste wir einsetzen und wie du deine Einwilligungen verwalten kannst. Gemäß TTDSG/GDPR setzen wir <strong>nicht-essenzielle</strong> Dienste erst nach deiner <strong>aktiven Zustimmung</strong> ein. Du kannst deine Entscheidung jederzeit widerrufen.</p>
  </header>

  <main class="container">
    <section class="panel pad">
      <h2>Deine aktuellen Einstellungen</h2>
      <div id="consent-status" class="row" aria-live="polite"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="open-settings">Einstellungen öffnen</button>
        <button class="btn ghost" id="revoke-consent">Einwilligungen widerrufen</button>
      </div>
    </section>

    <section class="panel pad" style="margin-top:18px">
      <h2>Eingebundene Dienste</h2>
      <p class="muted">Keine Werbung, kein Datenverkauf. Wir nutzen lediglich <strong>Google Analytics</strong> zur Reichweitenmessung. Externe Medien (YouTube, Calendly) werden erst nach Einwilligung geladen.</p>

      <div class="grid" style="margin-top:12px">
        <!-- Google Analytics (Analytics) -->
        <div class="card">
          <h3 style="margin:6px 0 6px">Google Analytics</h3>
          <p class="muted">Kategorie: Analyse. Wird nur geladen, wenn du Analyse akzeptierst.</p>
          <div class="center">
            <div class="placeholder">
              <strong id="ga-state">Aktuell: nicht geladen</strong>
              <small>Nach Zustimmung zu „Analyse“ wird GA eingebunden.</small>
              <div class="row">
                <button class="btn primary" data-action="enable-analytics">Analyse erlauben</button>
                <button class="btn" data-action="open-settings">Einstellungen</button>
              </div>
            </div>
          </div>
        </div>

        <!-- YouTube (Externe Medien) -->
        <div class="card">
          <h3 style="margin:6px 0 6px">YouTube‑Video</h3>
          <p class="muted">Kategorie: Externe Medien. Wir setzen den nocookie‑Modus und laden erst nach Zustimmung.</p>
          <div class="center">
            <div class="placeholder" data-consent-block="external" data-type="youtube" data-video="dQw4w9WgXcQ">
              <strong>Gesperrt bis Zustimmung</strong>
              <small>Externe Medien zulassen, um das Video zu laden.</small>
              <div class="row">
                <button class="btn success" data-action="enable-external">Externe Medien erlauben</button>
                <button class="btn" data-action="open-settings">Einstellungen</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Calendly (Externe Medien) -->
        <div class="card">
          <h3 style="margin:6px 0 6px">Termin buchen (Calendly)</h3>
          <p class="muted">Kategorie: Externe Medien. Lädt erst nach Zustimmung.</p>
          <div class="center">
            <div class="placeholder" data-consent-block="external" data-type="calendly" data-url="https://calendly.com/DEIN-BENUTZER/30min">
              <strong>Gesperrt bis Zustimmung</strong>
              <small>Externe Medien zulassen, um den Kalender zu laden.</small>
              <div class="row">
                <button class="btn success" data-action="enable-external">Externe Medien erlauben</button>
                <button class="btn" data-action="open-settings">Einstellungen</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Kontaktformular (Essenziell) -->
        <div class="card">
          <h3 style="margin:6px 0 6px">Kontaktformular</h3>
          <p class="muted">Kategorie: Essenziell (erforderlich für die Kommunikation). Keine Drittanbieter‑Cookies.</p>
          <form class="panel pad" id="contact-form" action="/api/contact" method="post" style="background:transparent">
            <input class="input" type="text" name="name" placeholder="Dein Name" required style="margin-bottom:8px">
            <input class="input" type="email" name="email" placeholder="E‑Mail" required style="margin-bottom:8px">
            <textarea class="input" name="message" placeholder="Nachricht" rows="4" required style="margin-bottom:12px"></textarea>
            <label style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
              <input type="checkbox" required>
              <span class="muted">Ich habe die <a href="/privacy" target="_blank" rel="noopener">Datenschutzhinweise</a> gelesen und stimme der Verarbeitung zum Zweck der Kontaktaufnahme zu.</span>
            </label>
            <button class="btn primary" type="submit">Nachricht senden</button>
          </form>
        </div>
      </div>
    </section>

    <section class="panel pad" style="margin-top:18px">
      <h2>Rechtsgrundlagen & Hinweise</h2>
      <ul>
        <li><strong>Essenziell</strong>: technisch notwendige Cookies/Funktionen zur Anzeige und Sicherheit der Website.</li>
        <li><strong>Analyse</strong>: Google Analytics (anonymisierte IP, sofern konfiguriert). Wird erst nach Einwilligung geladen.</li>
        <li><strong>Externe Medien</strong>: YouTube (nocookie), Calendly. Werden erst nach Einwilligung geladen.</li>
      </ul>
      <p class="muted">Du kannst deine Einstellungen jederzeit hier oder unten rechts (Schaltfläche) ändern. Ein Widerruf wirkt nur für die Zukunft.</p>
    </section>
  </main>

  <!-- Revoke Floating Button -->
  <div class="sticky-revoke">
    <button class="btn" id="revoke-fab" title="Cookie-Einstellungen">🍪</button>
  </div>

  <!-- Cookie Banner -->
  <div class="cookie-banner" id="cookie-banner" hidden>
    <div class="panel pad content">
      <div class="text">
        <strong>Cookies & Dienste</strong>
        <p class="muted" style="margin:6px 0 0">Wir nutzen essenzielle Cookies sowie – nur mit deiner Zustimmung – Analyse (Google Analytics) und Externe Medien (YouTube, Calendly). Du kannst jederzeit anpassen.</p>
      </div>
      <div class="row">
        <button class="btn" id="btn-settings">Einstellungen</button>
        <button class="btn" id="btn-reject">Nur essenziell</button>
        <button class="btn primary" id="btn-accept">Alle akzeptieren</button>
      </div>
    </div>
  </div>

  <!-- Cookie Settings Modal -->
  <dialog class="cookie-modal" id="cookie-modal" aria-label="Cookie-Einstellungen">
    <div class="modal-head">
      <strong>Cookie‑Einstellungen</strong>
      <button class="btn ghost" id="modal-close">Schließen</button>
    </div>
    <div class="modal-body">
      <div class="cat">
        <div class="meta">
          <div class="row" style="justify-content:space-between">
            <strong>Essenziell</strong>
            <span class="badge">immer aktiv</span>
          </div>
          <p class="muted">Erforderlich, um die Website bereitzustellen (z. B. Sicherheit/Grundfunktionen). Keine Drittanbieter‑Cookies.</p>
        </div>
        <div class="switch" data-on="true" aria-hidden="true"></div>
      </div>
      <div class="cat">
        <div class="meta">
          <strong>Analyse (Google Analytics)</strong>
          <p class="muted">Hilft uns, die Nutzung zu verstehen. Wird nur nach Einwilligung geladen.</p>
        </div>
        <button class="switch" id="toggle-analytics" data-on="false" aria-pressed="false" aria-label="Analyse aktivieren/deaktivieren"></button>
      </div>
      <div class="cat">
        <div class="meta">
          <strong>Externe Medien (YouTube, Calendly)</strong>
          <p class="muted">Inhalte von Drittplattformen. Laden erst nach Einwilligung.</p>
        </div>
        <button class="switch" id="toggle-external" data-on="false" aria-pressed="false" aria-label="Externe Medien aktivieren/deaktivieren"></button>
      </div>
      <div class="row" style="margin-top:14px;justify-content:flex-end">
        <button class="btn" id="save-partial">Speichern</button>
        <button class="btn primary" id="save-all">Alle akzeptieren</button>
      </div>
    </div>
  </dialog>

  <script src="consent.js"></script>
  <script>
    // ===== Consent Manager (Plain JS, ohne Dependencies) =====
    let consent = loadConsent();

    function persistConsent(next){
      consent = saveConsent(next);
      updateUI();
      applyConsent();
    }

    // UI Elements
    const banner = document.getElementById('cookie-banner');
    const modal = document.getElementById('cookie-modal');
    const btnSettings = document.getElementById('btn-settings');
    const btnReject = document.getElementById('btn-reject');
    const btnAccept = document.getElementById('btn-accept');
    const modalClose = document.getElementById('modal-close');
    const toggleAnalytics = document.getElementById('toggle-analytics');
    const toggleExternal = document.getElementById('toggle-external');
    const savePartial = document.getElementById('save-partial');
    const saveAll = document.getElementById('save-all');
    const statusEl = document.getElementById('consent-status');
    const revokeBtn = document.getElementById('revoke-consent');
    const revokeFab = document.getElementById('revoke-fab');
    const openSettings = document.getElementById('open-settings');

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      if(!('timestamp' in consent)) consent.timestamp = null;
      const firstVisit = !localStorage.getItem(LS_KEY);
      if(firstVisit) banner.hidden = false; // zeigen nur beim ersten Besuch
      updateUI();
      applyConsent();

      // Delegated clicks
      document.body.addEventListener('click', (e)=>{
        const act = e.target?.dataset?.action;
        if(act === 'enable-analytics') { toggleAnalytics.dataset.on = 'true'; savePartial.click(); }
        if(act === 'enable-external') { toggleExternal.dataset.on = 'true'; savePartial.click(); }
        if(act === 'open-settings') { openModal(); }
      });
    });

    function updateUI(){
      // Banner visibility
      banner.hidden = !!consent.timestamp; // verstecke Banner nach Entscheidung

      // Modal toggles
      toggleAnalytics.dataset.on = String(!!consent.analytics);
      toggleAnalytics.setAttribute('aria-pressed', String(!!consent.analytics));
      toggleExternal.dataset.on = String(!!consent.external);
      toggleExternal.setAttribute('aria-pressed', String(!!consent.external));

      // Status badges
      statusEl.innerHTML = '';
      const mk = (name, on)=>`<span class="badge" style="margin-right:8px">${name}: <strong>${on? 'an':'aus'}</strong></span>`;
      statusEl.insertAdjacentHTML('beforeend', mk('Essenziell', true));
      statusEl.insertAdjacentHTML('beforeend', mk('Analyse', !!consent.analytics));
      statusEl.insertAdjacentHTML('beforeend', mk('Externe Medien', !!consent.external));

      // GA panel state text
      const gaState = document.getElementById('ga-state');
      if(gaState) gaState.textContent = `Aktuell: ${consent.analytics? 'geladen' : 'nicht geladen'}`;
    }

    // Controls
    btnSettings.addEventListener('click', openModal);
    openSettings.addEventListener('click', openModal);
    modalClose.addEventListener('click', closeModal);
    revokeBtn.addEventListener('click', revokeConsent);
    revokeFab.addEventListener('click', openModal);

    toggleAnalytics.addEventListener('click', ()=>{
      const on = toggleAnalytics.dataset.on !== 'true';
      toggleAnalytics.dataset.on = String(on);
      toggleAnalytics.setAttribute('aria-pressed', String(on));
    });
    toggleExternal.addEventListener('click', ()=>{
      const on = toggleExternal.dataset.on !== 'true';
      toggleExternal.dataset.on = String(on);
      toggleExternal.setAttribute('aria-pressed', String(on));
    });

    btnReject.addEventListener('click', ()=> persistConsent({ analytics:false, external:false }));
    btnAccept.addEventListener('click', ()=> persistConsent({ analytics:true, external:true }));
    savePartial.addEventListener('click', ()=> persistConsent({
      analytics: toggleAnalytics.dataset.on === 'true',
      external:  toggleExternal.dataset.on === 'true'
    }));
    saveAll.addEventListener('click', ()=> persistConsent({ analytics:true, external:true }));

    function openModal(){ modal.showModal(); }
    function closeModal(){ modal.close(); }

    function revokeConsent(){
      localStorage.removeItem(LS_KEY);
      consent = {...DEFAULT, timestamp:null};
      updateUI();
      // Optional: Seite neu laden, um blockierte Skripte zu entfernen
      location.reload();
    }

    // ===== Apply consent: load or block services =====
    function applyConsent(){
      // Google Analytics (nur wenn erlaubt & noch nicht geladen)
      if(consent.analytics){
        enableGoogleAnalytics();
      }
      // YouTube & Calendly Platzhalter austauschen
      hydrateExternalPlaceholders();
    }

    // ---- Google Analytics ----
    let gaLoaded = false;
    function enableGoogleAnalytics(){
      if(gaLoaded) return; gaLoaded = true;
      const MID = 'G-XXXXXXXXXX'; // TODO: GA4 Measurement ID eintragen
      if(MID === 'G-XXXXXXXXXX'){ console.warn('Bitte GA4 Measurement ID setzen.'); return; }
      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;

      const s1 = document.createElement('script');
      s1.async = true; s1.src = `https://www.googletagmanager.com/gtag/js?id=${MID}`;
      document.head.appendChild(s1);

      const s2 = document.createElement('script');
      s2.text = `window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', '${MID}', { 'anonymize_ip': true });`;
      document.head.appendChild(s2);
    }

    // ---- External Media (YouTube, Calendly) ----
    function hydrateExternalPlaceholders(){
      const nodes = document.querySelectorAll('[data-consent-block]');
      nodes.forEach(node=>{
        const cat = node.getAttribute('data-consent-block');
        if(cat === 'external'){
          if(consent.external){
            const type = node.getAttribute('data-type');
            if(type === 'youtube'){
              const videoId = node.getAttribute('data-video');
              const iframe = document.createElement('iframe');
              iframe.width = '100%';
              iframe.height = '315';
              iframe.loading = 'lazy';
              iframe.referrerPolicy = 'strict-origin-when-cross-origin';
              iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
              iframe.allowFullscreen = true;
              iframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?rel=0`;
              node.replaceWith(iframe);
            }
            if(type === 'calendly'){
              const url = node.getAttribute('data-url');
              // Calendly inline embed
              const div = document.createElement('div');
              div.style.minHeight = '640px';
              div.className = 'panel pad';
              const s = document.createElement('script');
              s.src = 'https://assets.calendly.com/assets/external/widget.js'; s.async = true;
              document.head.appendChild(s);
              const l = document.createElement('link');
              l.rel = 'stylesheet'; l.href = 'https://assets.calendly.com/assets/external/widget.css';
              document.head.appendChild(l);
              div.setAttribute('data-auto-load', 'false');
              // Wenn Script geladen ist, rendern
              s.addEventListener('load', ()=>{
                if(window.Calendly){ window.Calendly.initInlineWidget({ url, parentElement: div }); }
              });
              node.replaceWith(div);
            }
          }
        }
      });
    }
  </script>
</body>
</html>
